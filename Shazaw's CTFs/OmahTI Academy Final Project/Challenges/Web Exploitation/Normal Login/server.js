const express = require('express');
const path = require('path');
const db = require('./database.js');
const app = express();
const port = 3000;

app.use(express.static('public'));
app.use(express.urlencoded({ extended: true }));

app.post('/login', (req, res) => {
    const username = req.body.username;
    const password = req.body.password;
    
    // VULNERABILITY: The query is built by concatenating user input directly.
    const sql = `SELECT * FROM users WHERE username = '${username}' AND password = '${password}'`;
    
    db.get(sql, [], (err, row) => {
        if (err) {
            res.status(500).send("An error occurred.");
            return console.error(err.message);
        }
        if (row) {
            const welcomeMessage = `<h1>Welcome, ${row.username}!</h1><p>Login successful.</p><p><b>Your Profile Bio:</b> ${row.description}</p><a href="/">Logout</a>`;
            res.send(welcomeMessage);
        } else {
            res.send('<h1>Login Failed</h1><p>Invalid username or password.</p><a href="/">Try again</a>');
        }
    });
});

app.listen(port, () => {
    console.log(`Vulnerable login app listening at http://localhost:${port}`);
});
